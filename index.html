<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeBomb - Assistant de Jeu</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Text:ital@0;1&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #2a2420 0%, #1a1815 50%, #2a2420 100%);
            min-height: 100vh;
            color: #e8dcc8;
            padding: 10px;
        }

        .border-frame {
            border: 12px solid #5a4a42;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 30px rgba(0,0,0,0.9);
            background: linear-gradient(135deg, #1a1815 0%, #232220 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 4px;
            background: linear-gradient(90deg, #C50D19 0%, #ff4444 50%, #C50D19 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 5s ease infinite;
            filter: drop-shadow(0 0 15px rgba(197, 13, 25, 0.6));
            text-transform: uppercase;
            display: inline-block;
        }

        @keyframes gradientShift {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }

        .screen { display: none; }
        .screen.active { display: block; }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: #C50D19;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .setup-section {
            background: rgba(90, 74, 66, 0.3);
            border: 2px solid #8a6f5e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 3px;
        }

        .player-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .player-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #8a6f5e;
            background: rgba(26, 24, 21, 0.8);
            color: #e8dcc8;
            font-family: 'Crimson Text', serif;
        }

        .player-input-group input:focus {
            outline: none;
            border-color: #C50D19;
            box-shadow: 0 0 15px rgba(197, 13, 25, 0.5);
        }

        .btn-remove {
            background: #C50D19;
            color: #fff;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-remove:hover {
            background: #e51d2b;
        }

        button {
            font-family: 'Playfair Display', serif;
            cursor: pointer;
            border-radius: 2px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-add-player {
            background: #0B787B;
            color: #fff;
            border: 2px solid #0B787B;
            padding: 10px 15px;
            margin-top: 10px;
        }

        .btn-add-player:hover {
            background: #0d9298;
            transform: translateY(-2px);
        }

        .btn-start {
            background: #C50D19;
            color: #fff;
            border: 2px solid #C50D19;
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            margin-top: 20px;
            display: none;
        }

        .btn-start.visible { display: block; }
        .btn-start:hover { background: #e51d2b; }

        .setup-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(26, 24, 21, 0.5);
            table-layout: fixed;
        }

        .setup-table th, .setup-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #5a4a42;
        }

        .setup-table th {
            background: #2a1f1a;
            color: #ff6666;
            font-weight: 700;
            border: 2px solid #C50D19;
        }

        .setup-table tr.highlight {
            background: rgba(197, 13, 25, 0.25);
            box-shadow: 0 0 20px rgba(197, 13, 25, 0.5);
        }

        .game-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .manche-counter {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            color: #C50D19;
            margin: 20px 0;
        }

        .turn-button {
            background: #8a6f5e;
            color: #e8dcc8;
            border: 2px solid #8a6f5e;
            width: 100%;
            padding: 30px 20px;
            font-size: 1.15rem;
            margin: 40px 0;
            text-transform: uppercase;
        }

        .end-manche-section {
            background: rgba(90, 74, 66, 0.3);
            border: 2px solid #8a6f5e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 3px;
        }

        .team-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(26, 24, 21, 0.5);
            margin-bottom: 10px;
        }

        .team-selector label {
            flex: 0 0 120px;
            font-weight: 600;
        }

        .team-toggle {
            display: flex;
            background: #5a4a42;
            flex: 1;
            border-radius: 2px;
        }

        .team-btn {
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            flex: 1;
            color: #8a7a6a;
            background: #5a4a42;
            font-family: 'Crimson Text', serif;
        }

        .team-btn.active {
            font-weight: 600;
            color: #fff;
        }

        .team-btn.blue.active { background: #0B787B; }
        .team-btn.red.active { background: #C50D19; }

        .winner-section {
            background: rgba(90, 74, 66, 0.3);
            border: 2px solid #8a6f5e;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .winner-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-winner {
            padding: 12px 20px;
            border: 2px solid;
            font-weight: 600;
            flex: 1;
        }

        .btn-winner.blue {
            background: #0B787B;
            border-color: #0B787B;
            color: #fff;
        }

        .btn-winner.red {
            background: #C50D19;
            border-color: #C50D19;
            color: #fff;
        }

        /* STATS */
        .stats-section {
            background: rgba(90, 74, 66, 0.3);
            border: 2px solid #8a6f5e;
            padding: 25px;
            margin-bottom: 20px;
        }

        .stats-section h2 {
            color: #C50D19;
            margin-bottom: 25px;
            font-size: 1.4rem;
        }

        /* HISTOGRAMME */
        .histogram-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            min-height: 350px;
            padding: 30px;
            background: rgba(26, 24, 21, 0.3);
            border-radius: 3px;
            overflow-x: auto;
        }

        .histogram-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .bar-vertical {
            width: 80px;
            height: 300px;
            display: flex;
            flex-direction: column-reverse;
            border: 2px solid #8a6f5e;
            border-radius: 4px;
            background: rgba(26, 24, 21, 0.5);
            overflow: hidden;
        }

        .bar-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            min-height: 25px;
            border-top: 1px solid rgba(0, 0, 0, 0.3);
        }

        .segment-blue-win {
            background: linear-gradient(180deg, #0d9298 0%, #0fb5ba 100%);
        }

        .segment-blue-lost {
            background: linear-gradient(180deg, #064a4e 0%, #085961 100%);
        }

        .segment-red-win {
            background: linear-gradient(180deg, #ff4444 0%, #ff6666 100%);
        }

        .segment-red-lost {
            background: linear-gradient(180deg, #6a0a12 0%, #8a0a14 100%);
        }

        .player-name-bar {
            text-align: center;
            color: #e8dcc8;
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .player-score {
            font-size: 0.85rem;
            color: #a89a8a;
        }

        /* PROGRESSION */
        .progression-player {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(26, 24, 21, 0.3);
            border-left: 4px solid #C50D19;
        }

        .progression-name {
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            color: #e8dcc8;
            margin-bottom: 8px;
        }

        .progression-line {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .progression-manche {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .manche-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid;
            font-size: 1.2rem;
            position: relative;
        }

        /* Animations continues */
        @keyframes emojiFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        @keyframes emojiSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes emojiBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes emojiShake {
            0%, 100% { transform: translateX(0px) scale(1); }
            25% { transform: translateX(-3px) scale(1); }
            75% { transform: translateX(3px) scale(1); }
            50% { transform: translateX(0px) scale(1.1); }
        }

        .manche-icon.blue-win {
            background: linear-gradient(135deg, #0d9298 0%, #0fb5ba 100%);
            border-color: #0B787B;
            box-shadow: 0 0 15px rgba(15, 181, 186, 0.8);
            animation: emojiBounce 0.6s ease-in-out infinite;
        }

        .manche-icon.blue-lost {
            background: linear-gradient(135deg, #d97a6a 0%, #e5937f 100%);
            border-color: #8a4a3a;
            animation: emojiShake 0.5s ease-in-out infinite;
        }

        .manche-icon.red-win {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            border-color: #C50D19;
            box-shadow: 0 0 15px rgba(255, 100, 0, 0.8);
            animation: emojiBounce 0.6s ease-in-out infinite;
        }

        .manche-icon.red-lost {
            background: linear-gradient(135deg, #d97a6a 0%, #e5937f 100%);
            border-color: #8a4a3a;
            animation: emojiShake 0.5s ease-in-out infinite;
        }

        .manche-number {
            font-size: 0.7rem;
            color: #a89a8a;
        }

        /* TABLEAU RESUMES */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(26, 24, 21, 0.5);
        }

        .summary-table th {
            background: #2a1f1a;
            color: #ff6666;
            padding: 12px;
            text-align: left;
            border: 2px solid #C50D19;
            font-weight: 700;
        }

        .summary-table td {
            padding: 12px;
            border: 1px solid #5a4a42;
            color: #d8ccbc;
        }

        .summary-table tr:hover {
            background: rgba(197, 13, 25, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            background: #0B787B;
            color: #fff;
            border: 2px solid #0B787B;
            padding: 12px 20px;
            flex: 1;
            min-width: 150px;
        }

        .btn-action:hover {
            transform: translateY(-3px);
        }

        .btn-end {
            background: #8a6f5e;
            border-color: #8a6f5e;
            color: #e8dcc8;
        }
    </style>
</head>
<body>
    <div class="border-frame">
        <div class="container">
            <header>
                <div class="logo">‚è∞ TimeBomb üí£</div>
            </header>

            <!-- SETUP -->
            <div id="setupScreen" class="screen active">
                <div class="setup-section">
                    <div class="section-title">üë• Ajoute les Joueurs</div>
                    <div id="playersInput"></div>
                    <button class="btn-add-player" onclick="addPlayer()">+ Ajouter un Joueur</button>
                </div>

                <div class="setup-section">
                    <div class="section-title">üìã Tableau de Mise en Place</div>
                    <table class="setup-table">
                        <thead><tr><th>Joueurs</th><th>üé¥</th><th>‚ö°</th><th>üí£</th></tr></thead>
                        <tbody id="setupTableBody">
                            <tr><td>4</td><td>15</td><td>4</td><td>1</td></tr>
                            <tr><td>5</td><td>19</td><td>5</td><td>1</td></tr>
                            <tr><td>6</td><td>23</td><td>6</td><td>1</td></tr>
                            <tr><td>7</td><td>27</td><td>7</td><td>1</td></tr>
                            <tr><td>8</td><td>31</td><td>8</td><td>1</td></tr>
                        </tbody>
                    </table>
                </div>

                <button id="btnStart" class="btn-start" onclick="startGame()">üöÄ D√©marrer</button>
            </div>

            <!-- GAME -->
            <div id="gameScreen" class="screen">
                <div class="game-header">
                    <div style="color: #a89a8a; font-size: 0.85rem;">Manche</div>
                    <div class="manche-counter" id="mancheDisplay">1</div>
                </div>
                <button class="turn-button" onclick="endTurn()">‚è±Ô∏è Fin de Manche</button>
            </div>

            <!-- END TURN -->
            <div id="endTurnScreen" class="screen">
                <div class="game-header">
                    <div style="color: #a89a8a; font-size: 0.85rem;">√âquipes</div>
                    <div class="manche-counter" id="mancheEndDisplay">1</div>
                </div>

                <div class="end-manche-section">
                    <div id="teamAssignment"></div>
                </div>

                <div class="winner-section">
                    <h3 style="color: #a89a8a; margin-bottom: 15px;">üé≠ Gagnant?</h3>
                    <div class="winner-buttons">
                        <button class="btn-winner blue" onclick="setWinner('blue')">üîµ Sherlock</button>
                        <button class="btn-winner red" onclick="setWinner('red')">üî¥ Moriarty</button>
                    </div>
                </div>
            </div>

            <!-- STATS -->
            <div id="statsScreen" class="screen">
                <div class="stats-section">
                    <h2>üìä Histogramme</h2>
                    <div class="histogram-container" id="histogram"></div>

                    <h2 style="margin-top: 40px;">üìà Progression</h2>
                    <div id="progressionChart"></div>

                    <h2 style="margin-top: 40px;">üìã R√©sum√© des Manches</h2>
                    <div id="manchesSummary"></div>
                </div>

                <div class="control-buttons">
                    <button class="btn-action" id="continueBtn" onclick="nextManche()">‚ûú Manche Suivante</button>
                    <button class="btn-action btn-end" id="endBtn" onclick="endGame()">Fin du Jeu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            players: [],
            currentManche: 1,
            teamAssignment: {},
            mancheHistory: []
        };

        function saveGameData() {
            localStorage.setItem('timebombGameState', JSON.stringify(gameState));
        }

        function loadGameData() {
            const saved = localStorage.getItem('timebombGameState');
            if (saved) gameState = JSON.parse(saved);
        }

        function addPlayer() {
            const container = document.getElementById('playersInput');
            const div = document.createElement('div');
            div.className = 'player-input-group';
            div.innerHTML = `
                <input type="text" placeholder="Nom du joueur" class="player-input">
                <button class="btn-remove" onclick="removePlayer(this)">‚úï</button>
            `;
            container.appendChild(div);
            div.querySelector('input').focus();
            updateTableHighlight();
            updateButtonVisibility();
        }

        function removePlayer(btn) {
            btn.parentElement.remove();
            updateTableHighlight();
            updateButtonVisibility();
        }

        function updateTableHighlight() {
            const playerCount = document.querySelectorAll('.player-input').length;
            document.querySelectorAll('#setupTableBody tr').forEach(row => {
                row.classList.remove('highlight');
                if (parseInt(row.cells[0].textContent) === playerCount) {
                    row.classList.add('highlight');
                }
            });
        }

        function updateButtonVisibility() {
            const playerCount = document.querySelectorAll('.player-input').length;
            document.getElementById('btnStart').classList.toggle('visible', playerCount >= 4 && playerCount <= 8);
        }

        function startGame() {
            const inputs = document.querySelectorAll('.player-input');
            gameState.players = Array.from(inputs)
                .map(i => i.value.trim())
                .filter(n => n.length > 0);

            if (gameState.players.length < 4) {
                alert('Minimum 4 joueurs!');
                return;
            }

            gameState.currentManche = 1;
            gameState.mancheHistory = [];
            gameState.teamAssignment = {};
            gameState.players.forEach(p => {
                gameState.teamAssignment[p] = null;
            });

            document.getElementById('mancheDisplay').textContent = gameState.currentManche;
            switchScreen('gameScreen');
            saveGameData();
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function endTurn() {
            document.getElementById('mancheEndDisplay').textContent = gameState.currentManche;
            renderTeamAssignment();
            switchScreen('endTurnScreen');
        }

        function renderTeamAssignment() {
            const container = document.getElementById('teamAssignment');
            container.innerHTML = '';
            gameState.players.forEach(player => {
                const selected = gameState.teamAssignment[player];
                const div = document.createElement('div');
                div.className = 'team-selector';
                div.innerHTML = `
                    <label>${player}</label>
                    <div class="team-toggle">
                        <button class="team-btn blue ${selected === 'blue' ? 'active' : ''}" onclick="assignTeam('${player}', 'blue')">üîµ</button>
                        <button class="team-btn red ${selected === 'red' ? 'active' : ''}" onclick="assignTeam('${player}', 'red')">üî¥</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function assignTeam(player, team) {
            gameState.teamAssignment[player] = team;
            renderTeamAssignment();
        }

        function setWinner(team) {
            const allAssigned = gameState.players.every(p => gameState.teamAssignment[p]);
            if (!allAssigned) {
                alert('Tous les joueurs doivent avoir une √©quipe!');
                return;
            }

            gameState.mancheHistory.push({
                manche: gameState.currentManche,
                assignments: {...gameState.teamAssignment},
                winner: team
            });

            renderStats();
            switchScreen('statsScreen');
            saveGameData();

            if (gameState.currentManche >= 4) {
                document.getElementById('continueBtn').style.display = 'none';
            }
        }

        function renderStats() {
            const playerStats = {};
            gameState.players.forEach(p => {
                playerStats[p] = [];
            });

            gameState.mancheHistory.forEach(round => {
                gameState.players.forEach(p => {
                    const team = round.assignments[p];
                    const won = round.winner === team;
                    playerStats[p].push({team, won, manche: round.manche});
                });
            });

            renderHistogram(playerStats);
            renderProgression(playerStats);
            renderManchesSummary();
        }

        function renderHistogram(playerStats) {
            const histogram = document.getElementById('histogram');
            histogram.innerHTML = '';

            gameState.players.forEach(player => {
                const stats = playerStats[player];
                let blueWin = 0, blueLost = 0, redWin = 0, redLost = 0, totalWins = 0;

                stats.forEach(s => {
                    if (s.team === 'blue') {
                        if (s.won) { blueWin++; totalWins++; }
                        else blueLost++;
                    } else if (s.team === 'red') {
                        if (s.won) { redWin++; totalWins++; }
                        else redLost++;
                    }
                });

                const total = blueWin + blueLost + redWin + redLost;

                let bar = '<div class="bar-vertical">';
                if (blueWin > 0) bar += `<div class="bar-segment segment-blue-win" style="flex: ${blueWin};">${blueWin}</div>`;
                if (blueLost > 0) bar += `<div class="bar-segment segment-blue-lost" style="flex: ${blueLost};">${blueLost}</div>`;
                if (redWin > 0) bar += `<div class="bar-segment segment-red-win" style="flex: ${redWin};">${redWin}</div>`;
                if (redLost > 0) bar += `<div class="bar-segment segment-red-lost" style="flex: ${redLost};">${redLost}</div>`;
                bar += '</div>';

                histogram.innerHTML += `
                    <div class="histogram-bar">
                        ${bar}
                        <div class="player-name-bar">
                            <div>${player}</div>
                            <div class="player-score">${totalWins}/${total}</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderProgression(playerStats) {
            const progression = document.getElementById('progressionChart');
            progression.innerHTML = '';

            gameState.players.forEach(player => {
                const stats = playerStats[player];
                
                // Calculer le rang actuel
                let totalWins = 0;
                stats.forEach(s => {
                    if (s.won) totalWins++;
                });
                
                const rankAbove = gameState.players.filter(p => {
                    let wins = 0;
                    playerStats[p].forEach(s => { if (s.won) wins++; });
                    return wins > totalWins;
                }).length;
                const rank = rankAbove + 1;
                
                const ranks = ['ü•á 1er', 'ü•à 2√®me', 'ü•â 3√®me', '4√®me', '5√®me', '6√®me', '7√®me', '8√®me'];
                const rankLabel = ranks[rank - 1] || rank + '√®me';

                let html = `<div class="progression-player">
                    <div class="progression-name">${player} <span style="color: #a89a8a; font-size: 0.9rem;">- ${rankLabel}</span></div>
                    <div class="progression-line">`;

                stats.forEach((s) => {
                    // Trouver le gagnant de la manche
                    const roundWinner = gameState.mancheHistory.find(r => r.manche === s.manche).winner;
                    const playerWon = roundWinner === s.team;
                    
                    let emoji, type, bgColor;
                    
                    if (playerWon) {
                        // Gagnant: affiche son emoji
                        if (s.team === 'blue') {
                            emoji = '‚úÇÔ∏è';
                            type = 'blue-win';
                        } else {
                            emoji = 'üí£';
                            type = 'red-win';
                        }
                    } else {
                        // Perdant: üò≠
                        emoji = 'üò≠';
                        type = s.team === 'blue' ? 'blue-lost' : 'red-lost';
                    }
                    
                    // Couleur de fond selon le gagnant de la manche
                    bgColor = roundWinner === 'blue' ? '#0B787B' : '#C50D19';

                    html += `<div class="progression-manche">
                        <div class="manche-icon ${type}">${emoji}</div>
                        <div class="manche-number">M${s.manche}</div>
                    </div>`;
                });

                html += '</div></div>';
                progression.innerHTML += html;
            });
        }

        function renderManchesSummary() {
            const summary = document.getElementById('manchesSummary');
            let html = '<table class="summary-table"><thead><tr><th>Manche</th><th>üîµ</th><th>üî¥</th><th>Gagnant</th></tr></thead><tbody>';

            gameState.mancheHistory.forEach(round => {
                const blue = gameState.players.filter(p => round.assignments[p] === 'blue').join(', ');
                const red = gameState.players.filter(p => round.assignments[p] === 'red').join(', ');
                const winner = round.winner === 'blue' ? 'üîµ' : 'üî¥';
                const bgColor = round.winner === 'blue' ? 'rgba(11, 120, 123, 0.15)' : 'rgba(197, 13, 25, 0.15)';

                html += `<tr style="background: ${bgColor};"><td>M${round.manche}</td><td>${blue}</td><td>${red}</td><td>${winner}</td></tr>`;
            });

            html += '</tbody></table>';
            summary.innerHTML = html;
        }

        function nextManche() {
            gameState.currentManche++;
            gameState.teamAssignment = {};
            gameState.players.forEach(p => {
                gameState.teamAssignment[p] = null;
            });
            document.getElementById('mancheDisplay').textContent = gameState.currentManche;
            switchScreen('gameScreen');
            saveGameData();
        }

        function endGame() {
            alert('Partie Termin√©e!');
            resetGame();
        }

        function resetGame() {
            gameState = {players: [], currentManche: 1, teamAssignment: {}, mancheHistory: []};
            localStorage.removeItem('timebombGameState');
            location.reload();
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadGameData();
            updateButtonVisibility();
        });
    </script>
</body>
</html>